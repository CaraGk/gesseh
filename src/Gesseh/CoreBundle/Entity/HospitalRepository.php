<?php

/**
 * This file is part of GESSEH project
 *
 * @author: Pierre-François ANGRAND <gesseh@medlibre.fr>
 * @copyright: Copyright 2013-2016 Pierre-François Angrand
 * @license: GPLv3
 * See LICENSE file or http://www.gnu.org/licenses/gpl.html
 */

namespace Gesseh\CoreBundle\Entity;

use Doctrine\ORM\EntityRepository;

/**
 * HospitalRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class HospitalRepository extends EntityRepository
{
  public function getHospitalQuery()
  {
    return $this->createQueryBuilder('h')
                ->join('h.departments', 'd')
                ->join('d.accreditations', 'a')
                ->join('a.sector', 's')
                ->addSelect('d')
                ->addSelect('a')
                ->addSelect('s')
                ->where('a.end > :now')
                ->setParameter('now', new \DateTime('now'))
    ;
  }

  public function getAllOrdered(array $orderBy = array ( 'h' => 'asc', 'd' => 'asc'))
  {
    $query = $this->getHospitalQuery();
    $query->addOrderBy('h.name', 'asc');
    foreach ($orderBy as $col => $order) {
      $query->addOrderBy($col . '.name', $order);
    }

    return $query->getQuery()
                 ->getResult();
  }

  public function getAll(array $arg)
  {
      $query = $this->getHospitalQuery();

      if($arg['period']) {
          $query->join('d.repartitions', 'r')
              ->join('r.period', 'p')
              ->addSelect('r')
              ->andWhere('p.id = :id')
              ->setParameter('id', $arg['period'])
          ;
      }

      $query->addOrderBy('h.name', 'asc')
            ->addOrderBy('d.name', 'asc');

    if (null != $arg['limit'] and (preg_match('/^[s,h,d].id$/', $arg['limit']['type']) or $arg['limit']['type'] == "r.cluster")) {
      $query->andWhere($arg['limit']['type'] . ' = :value')
            ->setParameter('value', $arg['limit']['value']);
    }

      return $query->getQuery()
                   ->getResult();
  }
}
